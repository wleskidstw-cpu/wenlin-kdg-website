// --- 數據存取通用函數 (Firestore CRUD) ---
// 這是所有 CRUD 操作的基礎，必須保留。
async function getRequests(collectionName, sortingField = 'timestamp', sortDirection = 'desc') {
    const collectionRef = collection(db, collectionName);
    const q = query(collectionRef, orderBy(sortingField, sortDirection)); 
    
    try {
        const querySnapshot = await getDocs(q);
        const data = querySnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        return data;
    } catch (e) {
        console.error(`Error getting documents from ${collectionName}: `, e);
        return [];
    }
}

async function updateRequest(collectionName, docId, data) {
    const docRef = doc(db, collectionName, docId);
    try {
        if (!docId || typeof docId !== 'string') {
            throw new Error('Invalid document ID provided for update.');
        }
        await updateDoc(docRef, data);
        return true;
    } catch (e) {
        console.error(`Error updating document ${docId} in ${collectionName}: `, e);
        return false;
    }
}

// --- 核心行事曆管理邏輯 ---

// 定義常數，確保程式碼可讀性
const CALENDAR_KEY = 'calendar_entries'; 
const auth = getAuth(app); // 假設 auth 已在檔案頂部初始化

function loadCalendarManagement() {
    document.getElementById('calendar-form').reset();
    document.getElementById('edit-calendar-id').value = '';
    document.getElementById('calendar-form').querySelector('button[type="submit"]').textContent = '新增行事曆項目';
    renderCalendarEntries();
}

async function getCalendarEntries() {
    return await getRequests(CALENDAR_KEY, 'date', 'asc');
}

async function saveCalendarEntry(event) {
    event.preventDefault();
    if (!auth.currentUser) {
        alert('您必須先登入才能新增行事曆項目。');
        return;
    }
    const form = event.target;
    const date = form.elements['calendar-date'].value;
    const title = form.elements['calendar-title'].value;
    const note = form.elements['calendar-note'].value;
    const editIdInput = document.getElementById('edit-calendar-id');
    const editId = editIdInput.value;

    let messageText = '';
    const data = { date, title, note, timestamp: new Date().toISOString() };

    try {
        if (editId) {
            // 執行更新
            await updateRequest(CALENDAR_KEY, editId, data);
            messageText = '行事曆項目已成功更新！主網頁將同步更新。';
        } else {
            // 執行創建
            await addDoc(collection(db, CALENDAR_KEY), data);
            messageText = '行事曆項目已成功新增！主網頁將同步更新。';
        }
    } catch (e) {
        console.error("Error saving calendar entry: ", e);
        alert(`儲存行事曆項目失敗。請檢查 Firebase 安全規則：${e.message}`);
        return;
    }
    
    form.reset();
    editIdInput.value = '';
    document.getElementById('calendar-form').querySelector('button[type="submit"]').textContent = '新增行事曆項目';
    
    alert(messageText);
    renderCalendarEntries();
}

async function deleteCalendarEntry(id) {
    if (!confirm("確定要刪除此行事曆項目嗎？")) return;
    if (!auth.currentUser) {
        alert('您必須先登入才能刪除行事曆項目。');
        return;
    }
    try {
        await deleteDoc(doc(db, CALENDAR_KEY, id));
        alert('行事曆項目已刪除。');
        renderCalendarEntries();
    } catch (e) {
        console.error("Error removing calendar entry: ", e);
        alert(`刪除失敗。請檢查 Firebase 安全規則：${e.message}`);
    }
}

function editCalendarEntry(id) {
    getCalendarEntries().then(entries => {
        const entry = entries.find(e => e.id === id);

        if (!entry) return;

        // 填入表單
        document.getElementById('calendar-date').value = entry.date;
        document.getElementById('calendar-title').value = entry.title; 
        document.getElementById('calendar-note').value = entry.note;

        // 設定編輯模式
        document.getElementById('edit-calendar-id').value = id;
        document.getElementById('calendar-form').querySelector('button[type="submit"]').textContent = '更新項目';
        
        document.getElementById('calendar-management').scrollIntoView({ behavior: 'smooth' });
    });
}

function renderCalendarEntries() {
    getCalendarEntries().then(entries => {
        const listContainer = document.getElementById('calendar-list');
        listContainer.innerHTML = '';

        if (entries.length === 0) {
            listContainer.innerHTML = '<p class="text-stone-500">目前沒有行事曆項目。</p>';
            return;
        }

        entries.forEach(entry => {
            const item = document.createElement('div');
            item.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2';
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-start';
            header.innerHTML = `
                <div>
                    <p class="text-xs font-semibold text-teal-700">${entry.date}</p>
                    <span class="font-bold text-lg text-stone-800">${entry.title}</span>
                    ${entry.note ? `<p class="text-xs text-stone-500">${entry.note}</p>` : ''}
                </div>
                <div class="flex space-x-2 flex-shrink-0">
                    <button onclick="window.editCalendarEntry('${entry.id}')" class="text-sm text-teal-600 hover:underline">編輯</button>
                    <button onclick="window.deleteCalendarEntry('${entry.id}')" class="text-sm text-red-500 hover:text-red-700">刪除</button>
                </div>
            `;
            listContainer.appendChild(item);
        });
    });
}
// --- 公告管理邏輯 ---

// 公告集合鍵
const ANNOUNCEMENT_KEY = 'announcements';

async function getAnnouncements() {
    return await getRequests(ANNOUNCEMENT_KEY);
}

async function saveAnnouncement(event) {
    event.preventDefault();
    // 檢查是否已登入
    if (!auth.currentUser) {
        alert('您必須先登入才能發布公告。');
        return;
    }

    const form = event.target;
    const title = form.elements['announcement-title'].value;
    const content = form.elements['announcement-content'].value;
    const tag = form.elements['announcement-tag'].value;
    const date = form.elements['announcement-date'].value;
    const fileURL = document.getElementById('announcement-file-url').value.trim();
    const editIdInput = document.getElementById('edit-announcement-id');
    const editId = editIdInput.value;

    let messageText = '';
    const data = { title, content, tag, date, fileURL, timestamp: new Date().toISOString() };

    try {
        if (editId) {
            // 執行更新
            await updateRequest(ANNOUNCEMENT_KEY, editId, data);
            messageText = '公告已成功更新！主網頁將同步至雲端。';
        } else {
            // 執行創建
            await addDoc(collection(db, ANNOUNCEMENT_KEY), data);
            messageText = '新公告已成功儲存！主網頁將同步至雲端。';
        }
    } catch (e) {
        console.error("Error saving announcement entry: ", e);
        alert(`儲存公告項目失敗。請檢查 Firebase 安全規則：${e.message}`);
        return;
    }
    
    form.reset();
    document.getElementById('announcement-form').querySelector('button[type="submit"]').textContent = '儲存公告並發布';
    editIdInput.value = '';
    document.getElementById('announcement-date').value = new Date().toISOString().split('T')[0];
    
    const message = document.createElement('div');
    message.className = 'fixed bottom-5 right-5 p-4 bg-teal-600 text-white rounded-lg shadow-xl z-50 transition duration-300';
    message.textContent = messageText;
    document.body.appendChild(message);
    setTimeout(() => { message.remove(); }, 3000);
    
    renderAnnouncements();
}

// 刪除公告
async function deleteAnnouncement(id) {
    if (!confirm("確定要刪除這則公告嗎？")) return;
    if (!auth.currentUser) {
        alert('您必須先登入才能刪除公告。');
        return;
    }
    try {
        await deleteDoc(doc(db, ANNOUNCEMENT_KEY, id));
        alert('公告已刪除。');
        renderAnnouncements();
    } catch (e) {
        console.error("Error removing document: ", e);
        alert(`刪除失敗。請檢查 Firebase 安全規則：${e.message}`);
    }
}

// 編輯公告：將數據填入表單
function editAnnouncement(id) {
    getAnnouncements().then(announcements => {
        const ann = announcements.find(a => a.id === id);

        if (!ann) return;
        
        document.getElementById('announcement-title').value = ann.title;
        document.getElementById('announcement-content').value = ann.content;
        document.getElementById('announcement-tag').value = ann.tag;
        document.getElementById('announcement-date').value = ann.date;
        document.getElementById('announcement-file-url').value = ann.fileURL;

        document.getElementById('edit-announcement-id').value = id;
        document.querySelector('#announcements button[type="submit"]').textContent = '更新公告';
        
        document.getElementById('announcements').scrollIntoView({ behavior: 'smooth' });
    });
}

// 渲染公告列表
function renderAnnouncements() {
    getAnnouncements().then(announcements => {
        const listContainer = document.getElementById('announcement-list');
        listContainer.innerHTML = '';
        
        if (announcements.length === 0) {
            listContainer.innerHTML = '<p class="text-stone-500">目前沒有公告。</p>';
            return;
        }

        announcements.forEach(ann => {
            const item = document.createElement('div');
            item.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2';
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-start';
            header.innerHTML = `
                <div>
                    <span class="text-xs font-semibold text-teal-700 mr-2">[${ann.tag}]</span>
                    <span class="font-bold text-lg text-stone-800">${ann.title}</span>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.editAnnouncement('${ann.id}')" class="text-sm text-teal-600 hover:underline">編輯</button>
                    <button onclick="window.deleteAnnouncement('${ann.id}')" class="text-sm text-red-500 hover:text-red-700">刪除</button>
                </div>
            `;
            item.appendChild(header);

            const contentPreview = ann.content ? ann.content.substring(0, 50) + (ann.content.length > 50 ? '...' : '') : '無內容';
            const fileName = ann.fileURL ? ann.fileURL.split('/').pop() : '';

            item.innerHTML += `
                <p class="text-sm text-stone-600 whitespace-pre-wrap">${contentPreview}</p>
                <p class="text-xs text-stone-500 mt-1">發布於: ${ann.date}</p>
                ${ann.fileURL ? `<p class="text-xs text-teal-700 font-medium">附件: <a href="${ann.fileURL}" target="_blank" class="underline hover:text-teal-900">${fileName}</a></p>` : ''}
            `;
            
            listContainer.appendChild(item);
        });
    });
}

// 將需要被 HTML 直接調用的函數掛載到 window
window.saveAnnouncement = saveAnnouncement;
window.editAnnouncement = editAnnouncement;
window.deleteAnnouncement = deleteAnnouncement;
