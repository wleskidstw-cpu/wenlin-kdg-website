<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºåŒ—å¸‚åŒ—æŠ•å€æ–‡æ—åœ‹æ°‘å°å­¸é™„è¨­å¹¼å…’åœ’</title>
    <!-- è¼‰å…¥ Tailwind CSS å‡½å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Klee One (æ‰‹å¯«ç°¡ç´„é¢¨) å’Œ Inter (å…§æ–‡æ¸…æ™°ç”¨) å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Firebase ç›¸é—œ SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <style>
        body {
            /* å…§æ–‡ä½¿ç”¨æ¸…æ™°çš„ Inter */
@@ -84,7 +87,7 @@
        }
    </style>
</head>
<body class="text-stone-700">
<body>

    <!-- å°è¦½åˆ— (Header) -->
    <header class="sticky top-0 z-50 bg-white shadow-xl">
@@ -120,7 +123,7 @@
    <!-- æ‰‹æ©Ÿç‰ˆå´é‚Šé¸å–® (Sidebar Modal) -->
    <div id="mobile-sidebar" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50">
        <div class="absolute right-0 top-0 w-64 h-full bg-white shadow-lg p-6 transform transition-transform duration-300 translate-x-full">
            <button class="absolute top-4 right-4 text-stone-400 hover:text-stone-700" onclick="toggleSidebar()">
            <button onclick="toggleSidebar()" class="absolute top-4 right-4 text-stone-400 hover:text-stone-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-xl font-bold text-teal-700 mb-6 handwriting-font">ç¶²ç«™å°è¦½</h3>
@@ -518,18 +521,18 @@
                </h3>

                <!-- ç›¸ç°¿é è¦½ (4å¼µåœ–ç‰‡) - å¾ localStorage è®€å–åœ–ç‰‡ URL -->
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto mb-10" id="gallery-preview-container">
                 <div id="gallery-preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto mb-10">
                    <!-- åœ–ç‰‡å°‡ç”± JS æ¸²æŸ“ -->
                </div>

                <p class="text-lg text-stone-600 mb-8 max-w-2xl mx-auto">
                    é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œé€£çµè‡³ Google ç›¸ç°¿æˆ–å­¸æ ¡ç›¸ç°¿ç³»çµ±ï¼ŒæŸ¥çœ‹æ›´å¤šçš„å…¨åœ’æ´»å‹•ç…§ç‰‡å’Œå­©å­å€‘çš„ç²¾å½©ç¬é–“ã€‚
                </p>

                <!-- ç¨ç«‹é é¢é€£çµæŒ‰éˆ• (å·²ä¿®æ­£ç‚ºæŒ‡å‘ Google ç›¸ç°¿ç¶²å€) -->
                <a href="https://photos.google.com/u/1/albums" target="_blank" 
                <!-- ç¨ç«‹é é¢é€£çµæŒ‰éˆ• (å·²ä¿®æ­£ç‚ºæŒ‡å‘ teacher_admin_panel.html) -->
                <a href="teacher_admin_panel.html" target="_blank" 
                   class="mt-6 inline-block px-10 py-4 text-xl font-bold text-white bg-teal-600 rounded-full shadow-lg hover:bg-teal-700 transition duration-300 transform hover:scale-105">
                    é»æ­¤é€²å…¥å…¨åœ’ç›¸ç°¿é€£çµ â†’
                    ğŸ§‘â€ğŸ« æ•™å¸«å¾Œå°ç™»å…¥ â†’
                </a>
            </div>
        </section>
@@ -916,26 +919,40 @@
                // Helper to get normalized coordinates
                const getCoords = (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    // ä¿®æ­£: ä½¿ç”¨ clientX/Y ä¸¦æ¸›å» Canvas ç›¸å°è¦–å£çš„åç§»é‡
                    const clientX = e.clientX || e.touches?.[0].clientX;
                    const clientY = e.clientY || e.touches?.[0].clientY;

                    if (clientX === undefined || clientY === undefined) return null;

                    return {
                        x: (e.clientX - rect.left),
                        y: (e.clientY - rect.top)
                        x: (clientX - rect.left),
                        y: (clientY - rect.top)
                    };
                };

                // Mouse Events
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(getCoords(e)));
                this.canvas.addEventListener('mousedown', (e) => {
                    const coords = getCoords(e);
                    if (coords) this.startDrawing(coords);
                });
                this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                this.canvas.addEventListener('mousemove', (e) => this.draw(getCoords(e)));
                this.canvas.addEventListener('mousemove', (e) => {
                    const coords = getCoords(e);
                    if (coords) this.draw(coords);
                });

                // Touch Events
                // Touch Events (ç¢ºä¿è§¸æ§å‹•ä½œè¢« Canvas æ•ç²)
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // é˜²æ­¢æ»¾å‹•
                    this.startDrawing(getCoords(e.touches[0]));
                    e.preventDefault(); 
                    const coords = getCoords(e);
                    if (coords) this.startDrawing(coords);
                });
                this.canvas.addEventListener('touchend', this.stopDrawing.bind(this));
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // é˜²æ­¢æ»¾å‹•
                    this.draw(getCoords(e.touches[0]));
                    e.preventDefault(); 
                    const coords = getCoords(e);
                    if (coords) this.draw(coords);
                });
            }

@@ -1111,32 +1128,32 @@

        // --- å…¬å‘Šæ¸²æŸ“é‚è¼¯ ---
        function renderPublicAnnouncements() {
            // å¾ localStorage è®€å–æ•™å¸«ç™¼å¸ƒçš„å…¬å‘Š
            const announcements = getRequests(ANNOUNCEMENT_KEY);
            const listContainer = document.getElementById('public-announcement-list');
            listContainer.innerHTML = '';

            if (announcements.length === 0) {
                // å¦‚æœæ²’æœ‰å…¬å‘Šï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
                listContainer.innerHTML = `<p class="text-stone-500 text-center py-4">ç›®å‰å°šç„¡å…¬å‘Šå…§å®¹ã€‚</p>`;
                return;
            }

            // åªé¡¯ç¤ºå‰ä¸‰å€‹å…¬å‘Š
            announcements.slice(0, 3).forEach((ann, index) => {
                const tagColor = ann.tag === 'é‡è¦' ? 'border-amber-500' : ann.tag === 'æ´»å‹•' ? 'border-teal-500' : 'border-stone-500';
                const item = document.createElement('div');
                item.className = `block p-4 bg-white rounded-xl shadow hover:shadow-lg transition duration-300 border-l-4 ${tagColor} cursor-pointer`;
            // å¾ Firestore è®€å–æ•™å¸«ç™¼å¸ƒçš„å…¬å‘Š
            getAnnouncements().then(announcements => {
                const listContainer = document.getElementById('public-announcement-list');
                listContainer.innerHTML = '';

                // ä½¿ç”¨ onclick é¡¯ç¤ºå®Œæ•´çš„å…¬å‘Šå…§å®¹
                item.onclick = () => showAnnouncementDetails(ann.id);

                item.innerHTML = `
                    <p class="text-stone-500 text-sm">ã€${ann.tag}ã€‘${ann.date}</p>
                    <p class="text-lg font-semibold text-stone-800">${ann.title}</p>
                    <p class="text-sm text-stone-600 mt-1">${ann.content ? ann.content.substring(0, 50) + (ann.content.length > 50 ? '...' : '') : ''}</p>
                `;
                listContainer.appendChild(item);
                if (announcements.length === 0) {
                    listContainer.innerHTML = `<p class="text-stone-500 text-center py-4">ç›®å‰å°šç„¡å…¬å‘Šå…§å®¹ã€‚</p>`;
                    return;
                }

                // åªé¡¯ç¤ºå‰ä¸‰å€‹å…¬å‘Š
                announcements.slice(0, 3).forEach((ann, index) => {
                    const tagColor = ann.tag === 'é‡è¦' ? 'border-amber-500' : ann.tag === 'æ´»å‹•' ? 'border-teal-500' : 'border-stone-500';
                    const item = document.createElement('div');
                    item.className = `block p-4 bg-white rounded-xl shadow hover:shadow-lg transition duration-300 border-l-4 ${tagColor} cursor-pointer`;
                    
                    // ä½¿ç”¨ onclick é¡¯ç¤ºå®Œæ•´çš„å…¬å‘Šå…§å®¹
                    item.onclick = () => showAnnouncementDetails(ann.id);

                    item.innerHTML = `
                        <p class="text-stone-500 text-sm">ã€${ann.tag}ã€‘${ann.date}</p>
                        <p class="text-lg font-semibold text-stone-800">${ann.title}</p>
                        <p class="text-sm text-stone-600 mt-1">${ann.content ? ann.content.substring(0, 50) + (ann.content.length > 50 ? '...' : '') : ''}</p>
                    `;
                    listContainer.appendChild(item);
                });
            });
        }

@@ -1173,50 +1190,50 @@
        // --- è¡Œäº‹æ›†æ¸²æŸ“é‚è¼¯ (æ–°å¢) ---
        function renderPublicCalendar() {
            const container = document.getElementById('calendar-table-container');
            const entries = getRequests(CALENDAR_KEY) || [];
            container.innerHTML = ''; // Clear previous content

            if (entries.length === 0) {
                container.innerHTML = '<p class="text-stone-500 text-center py-8">ç›®å‰å°šç„¡è¡Œäº‹æ›†è³‡æ–™ï¼Œè«‹è€å¸«ç™»å…¥å¾Œå°æ–°å¢ã€‚</p>';
                return;
            }
            getCalendarEntries().then(entries => {
                container.innerHTML = ''; // Clear previous content

                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-stone-500 text-center py-8">ç›®å‰å°šç„¡è¡Œäº‹æ›†è³‡æ–™ï¼Œè«‹è€å¸«ç™»å…¥å¾Œå°æ–°å¢ã€‚</p>';
                    return;
                }

                // Sort entries by date (ascending)
                entries.sort((a, b) => new Date(a.date) - new Date(b.date));

                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="data-table w-full min-w-[500px] bg-white rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-teal-100 text-teal-800">
                                    <th class="w-[15%]">æ—¥æœŸ</th>
                                    <th class="w-[65%]">æ´»å‹•åç¨±</th>
                                    <th class="w-[20%]">å‚™è¨»/åœ°é»</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

            // Sort entries by date (ascending)
            entries.sort((a, b) => new Date(a.date) - new Date(b.date));

            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="data-table w-full min-w-[500px] bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-teal-100 text-teal-800">
                                <th class="w-[15%]">æ—¥æœŸ</th>
                                <th class="w-[65%]">æ´»å‹•åç¨±</th>
                                <th class="w-[20%]">å‚™è¨»/åœ°é»</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
                entries.forEach(entry => {
                    tableHtml += `
                        <tr>
                            <td>${entry.date}</td>
                            <td>${entry.title}</td>
                            <td>${entry.note || ''}</td>
                        </tr>
                    `;
                });

            entries.forEach(entry => {
                tableHtml += `
                    <tr>
                        <td>${entry.date}</td>
                        <td>${entry.title}</td>
                        <td>${entry.note || ''}</td>
                    </tr>
                `;
                tableHtml += `</tbody></table></div>`;
                container.innerHTML = tableHtml;
            });

            tableHtml += `</tbody></table></div>`;
            container.innerHTML = tableHtml;
        }


        // --- è«‹å‡è¡¨å–®æäº¤é‚è¼¯ (å¯«å…¥ localStorage) ---
        function handleLeaveSubmit(event) {
        // --- è«‹å‡è¡¨å–®æäº¤é‚è¼¯ (å¯«å…¥ Firestore) ---
        async function handleLeaveSubmit(event) {
            event.preventDefault(); 
            const form = event.target;
            const requests = getRequests(LEAVE_KEY);

            // é©—è­‰ç°½å
            if (!leaveSignaturePad || !leaveSignaturePad.getIsSigned()) {
@@ -1226,7 +1243,6 @@

            // æ”¶é›†è¡¨å–®æ•¸æ“š
            const newRequest = {
                id: Date.now(),
                parentName: form.parentName.value,
                relationship: form.relationship.value,
                childName: form.childName.value,
@@ -1240,28 +1256,33 @@
                timestamp: new Date().toISOString()
            };

            requests.unshift(newRequest);
            saveRequests(LEAVE_KEY, requests); // å„²å­˜åˆ° localStorage
            form.reset(); 
            leaveSignaturePad.clear(); // æ¸…ç©ºç°½åæ¿
            // ä½¿ç”¨ Firestore å¯«å…¥æ•¸æ“š
            try {
                await addDoc(collection(db, LEAVE_KEY), newRequest);
                
                form.reset(); 
                leaveSignaturePad.clear(); // æ¸…ç©ºç°½åæ¿

            const message = document.createElement('div');
            message.className = 'fixed bottom-5 right-5 p-4 bg-green-600 text-white rounded-lg shadow-xl z-50 transition duration-300';
            message.textContent = `è«‹å‡ç”³è«‹å·²æˆåŠŸé€å‡ºï¼è«‹è€å¸«ç™»å…¥å¾Œå°å¯©æ ¸ã€‚`;
            document.body.appendChild(message);
                const message = document.createElement('div');
                message.className = 'fixed bottom-5 right-5 p-4 bg-green-600 text-white rounded-lg shadow-xl z-50 transition duration-300';
                message.textContent = `è«‹å‡ç”³è«‹å·²æˆåŠŸé€å‡ºï¼æ•¸æ“šå·²åŒæ­¥è‡³é›²ç«¯ã€‚`;
                document.body.appendChild(message);

            setTimeout(() => {
                message.remove();
            }, 3000);
                setTimeout(() => {
                    message.remove();
                }, 3000);
            } catch (e) {
                console.error("æäº¤è«‹å‡å–®å¤±æ•—:", e);
                alert("æäº¤è«‹å‡å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }

            return false;
        }

        // --- è¨—è—¥è¡¨å–®æäº¤é‚è¼¯ (å¯«å…¥ localStorage) ---
        function handleMedicationSubmit(event) {
        // --- è¨—è—¥è¡¨å–®æäº¤é‚è¼¯ (å¯«å…¥ Firestore) ---
        async function handleMedicationSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const requests = getRequests(MEDICATION_KEY);

            // é©—è­‰ç°½å
            if (!medicationSignaturePad || !medicationSignaturePad.getIsSigned()) {
@@ -1289,7 +1310,6 @@

            // æ”¶é›†è¡¨å–®æ•¸æ“š
            const newRequest = {
                id: Date.now(),
                className: form.className.value,
                childName: form.childName.value,
                startDate: form.startDate.value,
@@ -1305,23 +1325,88 @@
                timestamp: new Date().toISOString()
            };

            requests.unshift(newRequest);
            saveRequests(MEDICATION_KEY, requests); // å„²å­˜åˆ° localStorage
            form.reset();
            medicationSignaturePad.clear(); // æ¸…ç©ºç°½åæ¿
            // ä½¿ç”¨ Firestore å¯«å…¥æ•¸æ“š
            try {
                await addDoc(collection(db, MEDICATION_KEY), newRequest);
                
                form.reset();
                medicationSignaturePad.clear(); // æ¸…ç©ºç°½åæ¿

            const message = document.createElement('div');
            message.className = 'fixed bottom-5 right-5 p-4 bg-green-600 text-white rounded-lg shadow-xl z-50 transition duration-300';
            message.textContent = `è¨—è—¥ç”³è«‹å·²æˆåŠŸé€å‡ºï¼è«‹è€å¸«ç™»å…¥å¾Œå°å¯©æ ¸ã€‚`;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
                const message = document.createElement('div');
                message.className = 'fixed bottom-5 right-5 p-4 bg-green-600 text-white rounded-lg shadow-xl z-50 transition duration-300';
                message.textContent = `è¨—è—¥ç”³è«‹å·²æˆåŠŸé€å‡ºï¼æ•¸æ“šå·²åŒæ­¥è‡³é›²ç«¯ã€‚`;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.remove();
                }, 3000);
            } catch (e) {
                console.error("æäº¤è¨—è—¥å–®å¤±æ•—:", e);
                alert("æäº¤è¨—è—¥å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }

            return false;
        }

        // --- Firestore æ•¸æ“šç²å– (å–ä»£ Local Storage) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDwaFkl2KMq6uNYKiUdoyKd2UWxIG85lMc",
            authDomain: "wleskidstw-dd0c3.firebaseapp.com",
            projectId: "wleskidstw-dd0c3",
            storageBucket: "wleskidstw-dd0c3.firebasestorage.app",
            messagingSenderId: "284932938662",
            appId: "1:284932938662:web:fb3e5c813143c2bfa60d67",
            measurementId: "G-M0P869XDQ2"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const LEAVE_KEY = 'leave_requests';
        const MEDICATION_KEY = 'medication_requests';
        const ANNOUNCEMENT_KEY = 'announcements';
        const GALLERY_KEY = 'gallery_images';
        const CALENDAR_KEY = 'calendar_entries'; 
        
        async function getAnnouncements() {
            const collectionRef = collection(db, ANNOUNCEMENT_KEY);
            const q = query(collectionRef, orderBy('timestamp', 'desc')); 
            
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error("Error getting documents: ", e);
                return [];
            }
        }
        
        async function getCalendarEntries() {
            const collectionRef = collection(db, CALENDAR_KEY);
            const q = query(collectionRef, orderBy('date', 'asc')); 
            
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error("Error getting documents: ", e);
                return [];
            }
        }
        
        async function getGalleryImages() {
            const collectionRef = collection(db, GALLERY_KEY);
            const q = query(collectionRef, orderBy('timestamp', 'asc')); 
            
            try {
                const querySnapshot = await getDocs(q);
                // åªè¿”å› URL é™£åˆ—ï¼Œä»¥åŒ¹é…åŸ Local Storage çµæ§‹
                return querySnapshot.docs.map(doc => doc.data().url);
            } catch (e) {
                console.error("Error getting documents: ", e);
                return [];
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ– Tab å’Œå…¬å‘Š
        window.onload = function() {
            showAboutTab('calendar');
@@ -1333,5 +1418,71 @@
        };
    </script>

    <!-- è…³æœ¬å¼•å…¥ Firestore æ‰€éœ€çš„æ¨¡çµ„å‡½æ•¸ -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        
        // é‡æ–°å®šç¾© Firebase config (é˜²æ­¢å¤šæ¬¡åŸ·è¡Œ)
        const firebaseConfig = {
            apiKey: "AIzaSyDwaFkl2KMq6uNYKiUdoyKd2UWxIG85lMc",
            authDomain: "wleskidstw-dd0c3.firebaseapp.com",
            projectId: "wleskidstw-dd0c3",
            storageBucket: "wleskidstw-dd0c3.firebasestorage.app",
            messagingSenderId: "284932938662",
            appId: "1:284932938662:web:fb3e5c813143c2bfa60d67",
            measurementId: "G-M0P869XDQ2"
        };
        
        // åˆå§‹åŒ– Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å°‡ Firestore å‡½æ•¸å°å‡ºåˆ° Window ä½œç”¨åŸŸä¾›å…¶ä»–è…³æœ¬ä½¿ç”¨
        window.getAnnouncements = async function() {
            const collectionRef = collection(db, 'announcements');
            const q = query(collectionRef, orderBy('timestamp', 'desc'));
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error("Error getting announcements from Firestore:", e);
                return [];
            }
        }

        window.getCalendarEntries = async function() {
            const collectionRef = collection(db, 'calendar_entries');
            const q = query(collectionRef, orderBy('date', 'asc'));
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error("Error getting calendar entries from Firestore:", e);
                return [];
            }
        }
        
        window.getGalleryImages = async function() {
            const collectionRef = collection(db, 'gallery_images');
            const q = query(collectionRef, orderBy('timestamp', 'asc'));
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data().url);
            } catch (e) {
                console.error("Error getting gallery images from Firestore:", e);
                return [];
            }
        }

        // ç”±æ–¼æ•´å€‹è…³æœ¬åœ¨ Preview ç’°å¢ƒä¸­å®¹æ˜“å‡ºéŒ¯ï¼Œæˆ‘å€‘ä½¿ç”¨ DOMContentLoaded ç¢ºä¿æ ¸å¿ƒæ¸²æŸ“åœ¨ DOM æº–å‚™å°±ç·’å¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
             // ç¢ºä¿åœ¨ DOM è¼‰å…¥æ™‚åŸ·è¡Œ Firestore è®€å–å’Œæ¸²æŸ“
            window.renderPublicAnnouncements();
            window.renderGalleryPreview();
            
            // ç”±æ–¼ showAboutTab('calendar') åœ¨ window.onload ä¸­èª¿ç”¨ï¼Œå®ƒæœƒåœ¨æ‰€æœ‰ DOM å…ƒç´ æº–å‚™å¥½å¾Œèª¿ç”¨ renderPublicCalendar()
        });
        
    </script>
</body>
